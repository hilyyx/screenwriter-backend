from fastapi import APIRouter
from lib.models.schemas import Params
from lib.llm.generator import Orchestrator
from fastapi import HTTPException

router = APIRouter()

class DialogueController:
    def __init__(self):
        self.generator_class = Orchestrator

    def generate(self, params: Params):
        generator = self.generator_class(params.dict())
        return generator.create_dialog()

dialogue_controller = DialogueController()

@router.post("/generate", tags=["Dialogue"])
def generate(params: Params):
    a = dialogue_controller.generate(params)
    print(a)

    """b = {
    "data": [
        {
            "id": 1,
            "info": "Сэм радостно сообщает о находке воды в оазисе после долгих поисков.",
            "type": "M",
            "mood": "радостный",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [
                {
                    "id": 2,
                    "mood": "нейтральный",
                    "line": "Эй, Сэм, что будем делать с этой водой? Делить поровну или есть идея получше?",
                    "info": "вопрос о воде",
                    "validation_result": {
                        "Соответствие персонажу": {
                            "rate": 8,
                            "comment": "Реплика отражает дерзкий стиль речи Майкла, но могла бы быть более выразительной в соответствии с его характером."
                        },
                        "Актуальность темы": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Связность истории": {
                            "rate": 7,
                            "comment": "Учитывая отсутствие предыдущих цепочек диалога, сложно оценить связность, но реплика логично вписывается в контекст оазиса."
                        },
                        "Ясность": {
                            "rate": 9,
                            "comment": "Реплика чёткая и однозначная, но могла бы быть немного более конкретной."
                        },
                        "Точность в рамках мира и лора": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Значимость": {
                            "rate": 8,
                            "comment": "Реплика вносит вклад в развитие сюжета, предлагая игроку сделать выбор, но могла бы более явно продвигать сюжет или развитие персонажей."
                        },
                        "Уникальность": {
                            "rate": 10,
                            "comment": ""
                        }
                    },
                    "need_regeneration": 0
                }
            ],
            "line": "Наконец-то! Видишь эту прозрачную воду, сверкающую под солнцем? После стольких дней блужданий по раскалённым пескам мы нашли настоящий оазис! Здесь можно отдохнуть, наполнить фляги и даже умыться — представь, какое это счастье в этой жаре. Природа всегда даёт надежду, даже в самых суровых местах. Давай насладимся этим моментом, друг. Вода — это жизнь, а сегодня нам повезло её найти!",
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 8,
                    "comment": "Отсутствие информации о предыдущих цепочках диалога делает оценку связности менее точной."
                },
                "Ясность": {
                    "rate": 10,
                    "comment": ""
                },
                "Точность в рамках мира и лора": {
                    "rate": 10,
                    "comment": ""
                },
                "Значимость": {
                    "rate": 9,
                    "comment": "Реплика вносит вклад в развитие атмосферы и вовлечение игрока, но незначительно продвигает сюжет."
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            },
            "need_regeneration": 0
        },
        {
            "id": 2,
            "info": "Сэм спрашивает Майкла, как поступить с обнаруженной водой.",
            "type": "C",
            "mood": "нейтральный",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [
                {
                    "id": 3,
                    "mood": "нейтральный",
                    "line": "Сэм, а ты уверен, что эту воду можно пить без опаски?",
                    "info": "вопрос о безопасности воды",
                    "need_regeneration": 0,
                    "validation_result": {
                        "Соответствие персонажу": {
                            "rate": 8,
                            "comment": "Реплика отражает некоторую долю скептицизма, что может соответствовать дерзкому характеру Майкла, однако могла бы быть более дерзкой."
                        },
                        "Актуальность темы": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Связность истории": {
                            "rate": 9,
                            "comment": "Реплика логично продолжает предыдущий диалог о воде в оазисе."
                        },
                        "Ясность": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Точность в рамках мира и лора": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Значимость": {
                            "rate": 7,
                            "comment": "Реплика вносит вклад в развитие сюжета, поднимая вопрос безопасности воды, но не значительно продвигает развитие персонажей."
                        },
                        "Уникальность": {
                            "rate": 8,
                            "comment": "Реплика уникальна в контексте текущего диалога, но подобные вопросы могли встречаться в других ситуациях."
                        }
                    }
                },
                {
                    "id": 4,
                    "mood": "злой",
                    "line": "Эй, Сэм, а что если вокруг этой воды кто-то или что-то опасное?",
                    "info": "выражение обеспокоенности опасностью",
                    "need_regeneration": 0,
                    "validation_result": {
                        "Соответствие персонажу": {
                            "rate": 8,
                            "comment": "Реплика отражает дерзкий характер Майкла, но могла бы быть более выразительной в соответствии с его стилем речи."
                        },
                        "Актуальность темы": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Связность истории": {
                            "rate": 9,
                            "comment": "Реплика логично продолжает диалог, но переход мог бы быть более плавным."
                        },
                        "Ясность": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Точность в рамках мира и лора": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Значимость": {
                            "rate": 8,
                            "comment": "Реплика добавляет напряжённости в сюжет, но её вклад в развитие персонажей мог бы быть более значительным."
                        },
                        "Уникальность": {
                            "rate": 10,
                            "comment": ""
                        }
                    }
                },
                {
                    "id": 5,
                    "mood": "благодарный",
                    "line": "Сэм, ты прав, давай оставим воду для других. Кто знает, может, она спасёт чью-то жизнь.",
                    "info": "предложение поделиться водой",
                    "need_regeneration": 1,
                    "validation_result": {
                        "Соответствие персонажу": {
                            "rate": 6,
                            "comment": "Реплика не полностью отражает дерзкий стиль речи Майкла. Она скорее демонстрирует зрелость и заботу, что может не соответствовать его характеру."
                        },
                        "Актуальность темы": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Связность истории": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Ясность": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Точность в рамках мира и лора": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Значимость": {
                            "rate": 8,
                            "comment": "Реплика вносит вклад в развитие персонажа и сюжета, но могла бы быть более значимой, если бы лучше отражала характер Майкла."
                        },
                        "Уникальность": {
                            "rate": 10,
                            "comment": ""
                        }
                    }
                }
            ],
            "line": "Майкл, в таких местах вода — это драгоценность. Давай сначала наполним наши фляги, чтобы хватило на путь обратно. Потом можно немного отдохнуть и умыться — заслужили после долгого перехода. Но главное — не тратить её зря. В пустыне каждый глоток на вес золота. Может, даже оставим немного для других путников? Вдруг кто-то ещё ищет спасения в этих песках. Как думаешь?",
            "need_regeneration": 0,
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 10,
                    "comment": ""
                },
                "Ясность": {
                    "rate": 10,
                    "comment": ""
                },
                "Точность в рамках мира и лора": {
                    "rate": 10,
                    "comment": ""
                },
                "Значимость": {
                    "rate": 10,
                    "comment": ""
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            }
        },
        {
            "id": 3,
            "info": "Сэм объясняет, что вода безопасна и пригодна для питья.",
            "type": "M",
            "mood": "воодушевлённый",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [
                {
                    "id": 6,
                    "mood": "нейтральный",
                    "line": "Давай уже попробуем эту воду, Сэм, а то я высох как верблюд!",
                    "info": "предложение попробовать воду",
                    "need_regeneration": 0,
                    "validation_result": {
                        "Соответствие персонажу": {
                            "rate": 8,
                            "comment": "Реплика отражает дерзкий характер Майкла, но сравнение 'высох как верблюд' может быть слишком разговорным для средневекового сеттинга."
                        },
                        "Актуальность темы": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Связность истории": {
                            "rate": 9,
                            "comment": "Реплика логично продолжает диалог о воде в оазисе."
                        },
                        "Ясность": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Точность в рамках мира и лора": {
                            "rate": 7,
                            "comment": "Использование современного сравнения может не полностью соответствовать средневековому сеттингу."
                        },
                        "Значимость": {
                            "rate": 8,
                            "comment": "Реплика способствует развитию сюжета и взаимодействию персонажей."
                        },
                        "Уникальность": {
                            "rate": 10,
                            "comment": ""
                        }
                    }
                }
            ],
            "line": "Конечно, Майкл! Видишь, как вода чиста и прозрачна? Это не просто случайный водоём — оазисы в пустыне питаются подземными источниками, а значит, вода здесь свежая и чистая. Я вижу, как в ней отражаются пальмы, и нет ни мутных пятен, ни странного запаха. Да и птицы пьют её без опаски — природа лучший индикатор. Но если хочешь быть совсем уверенным, давай проверим её вкус — просто сделаем маленький глоток. Если она свежая и прохладная, без горечи, значит, всё в порядке. Доверься мне, я много лет изучал такие места. Эта вода — настоящий дар пустыни!",
            "need_regeneration": 0,
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 10,
                    "comment": ""
                },
                "Ясность": {
                    "rate": 10,
                    "comment": ""
                },
                "Точность в рамках мира и лора": {
                    "rate": 9,
                    "comment": "Небольшое несоответствие историческому периоду, так как упоминание о геологии может быть не совсем уместно в средневековье."
                },
                "Значимость": {
                    "rate": 10,
                    "comment": ""
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            }
        },
        {
            "id": 4,
            "info": "Сэм выражает обеспокоенность возможными опасностями у воды.",
            "type": "M",
            "mood": "растерянный",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [
                {
                    "id": 7,
                    "mood": "нейтральный",
                    "line": "Сэм, а ты уверен, что эту воду можно пить без проверки?",
                    "info": "вопрос о безопасности воды",
                    "need_regeneration": 0,
                    "validation_result": {
                        "Соответствие персонажу": {
                            "rate": 8,
                            "comment": "Реплика отражает дерзкий характер Майкла, но могла бы быть более выразительной в соответствии с его стилем речи."
                        },
                        "Актуальность темы": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Связность истории": {
                            "rate": 9,
                            "comment": "Реплика логично продолжает предыдущий диалог, но переход мог бы быть немного плавнее."
                        },
                        "Ясность": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Точность в рамках мира и лора": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Значимость": {
                            "rate": 8,
                            "comment": "Реплика вносит вклад в развитие сюжета и повышает вовлечённость игрока, но могла бы быть более значимой для развития персонажей."
                        },
                        "Уникальность": {
                            "rate": 10,
                            "comment": ""
                        }
                    }
                }
            ],
            "line": "Хм... Ты прав, Майкл. Вода в пустыне редко бывает просто так — обычно вокруг неё кипит жизнь. И не всегда дружелюбная... Я слышал истории о скорпионах, прячущихся под камнями у воды, и даже о кочевниках, которые могут защищать свои источники. Давай будем осторожны — осмотримся, прежде чем расслабляться. Но не будем и паниковать: может, нам просто повезло, и этот оазис действительно безлюден. Главное — сохранять бдительность, друг.",
            "need_regeneration": 0,
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 9,
                    "comment": "Реплика логично продолжает диалог, но можно было бы более плавно перейти от предыдущего обсуждения воды к теме опасности."
                },
                "Ясность": {
                    "rate": 10,
                    "comment": ""
                },
                "Точность в рамках мира и лора": {
                    "rate": 10,
                    "comment": ""
                },
                "Значимость": {
                    "rate": 8,
                    "comment": "Реплика добавляет напряжённости и вовлекает игрока, но могла бы более явно влиять на развитие сюжета или персонажей."
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            }
        },
        {
            "id": 5,
            "info": "Сэм благодарит Майкла за вежливость и делится мудростью.",
            "type": "M",
            "mood": "благодарный",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [
                {
                    "id": 8,
                    "mood": "нейтральный",
                    "line": "Сэм, может, передохнём тут немного? Вода выглядит так заманчиво.",
                    "info": "предложение отдохнуть",
                    "need_regeneration": 0,
                    "validation_result": {
                        "Соответствие персонажу": {
                            "rate": 8,
                            "comment": "Реплика отражает желание отдохнуть, что соответствует усталости после долгого пути, но могла бы быть более дерзкой, чтобы полностью соответствовать стилю речи Майкла."
                        },
                        "Актуальность темы": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Связность истории": {
                            "rate": 9,
                            "comment": "Реплика логично продолжает предыдущий диалог, предлагая передохнуть у воды, что естественно после обсуждения её ценности."
                        },
                        "Ясность": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Точность в рамках мира и лора": {
                            "rate": 10,
                            "comment": ""
                        },
                        "Значимость": {
                            "rate": 7,
                            "comment": "Реплика вносит вклад в развитие сцены, предлагая действие, но не значительно продвигает сюжет или развитие персонажей."
                        },
                        "Уникальность": {
                            "rate": 8,
                            "comment": "Реплика уникальна в контексте текущего диалога, но идея отдыха у воды уже обсуждалась ранее."
                        }
                    }
                }
            ],
            "line": "Спасибо за твои добрые слова, Майкл. В пустыне, как и в жизни, важно не только выживать, но и оставаться человеком. Вежливость и уважение — это как вода в песках: кажется, что их мало, но они делают путь легче. Помни, даже в самых трудных ситуациях доброта и мудрость помогут найти правильное решение. Давай беречь не только воду, но и тепло в наших сердцах — оно согреет нас лучше любого костра.",
            "need_regeneration": 0,
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 9,
                    "comment": "Реплика хорошо связывается с предыдущими диалогами, но можно было бы более плавно перейти от темы воды к теме доброты и уважения."
                },
                "Ясность": {
                    "rate": 10,
                    "comment": ""
                },
                "Точность в рамках мира и лора": {
                    "rate": 10,
                    "comment": ""
                },
                "Значимость": {
                    "rate": 8,
                    "comment": "Реплика вносит вклад в развитие персонажа и вовлечение игрока, но могла бы более явно продвигать сюжет."
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            }
        },
        {
            "id": 6,
            "info": "Сэм предлагает Майклу немедленно попробовать воду.",
            "type": "C",
            "mood": "радостный",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [],
            "line": "Отлично, Майкл! Давай опустим руки в эту прохладную воду — почувствуй, как она освежает кожу! Сначала сделай маленький глоток, пусть она медленно пройдёт по горлу, утоляя жажду. Ах, этот вкус — свежий, чистый, будто сама пустыня шепчет нам: \"Отдохните, путники, вы заслужили!\" После такого долгого пути нет ничего лучше, чем ощутить эту живительную влагу. Пей не спеша, наслаждайся каждым глотком — сегодня нам действительно повезло!",
            "need_regeneration": 0,
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 10,
                    "comment": ""
                },
                "Ясность": {
                    "rate": 9,
                    "comment": "Реплика ясна, но могла бы быть немного короче для большей чёткости."
                },
                "Точность в рамках мира и лора": {
                    "rate": 10,
                    "comment": ""
                },
                "Значимость": {
                    "rate": 8,
                    "comment": "Реплика вносит вклад в развитие персонажей и вовлечение игрока, но могла бы более явно продвигать сюжет."
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            }
        },
        {
            "id": 7,
            "info": "Сэм настаивает на проверке воды перед употреблением.",
            "type": "C",
            "mood": "растерянный",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [],
            "line": "Ох, Майкл, ты поднял очень важный вопрос... Вода в пустыне может быть коварной — иногда даже прозрачная на вид, она содержит опасные соли или микроорганизмы. Я, как геолог, видел немало таких случаев... Давай не будем торопиться. У меня в рюкзаке есть простой тест-набор — проверим воду на минеральный состав. И лучше сначала попробовать каплю, подождать... Знаешь, в таких ситуациях лучше перестраховаться, чем потом жалеть. Вода — это жизнь, но только если она чистая. Давай проверим вместе, друг.",
            "need_regeneration": 0,
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 9,
                    "comment": "Реплика логично продолжает диалог, но могла бы более плавно переходить от предыдущего обсуждения опасностей вокруг воды к проверке её качества."
                },
                "Ясность": {
                    "rate": 10,
                    "comment": ""
                },
                "Точность в рамках мира и лора": {
                    "rate": 8,
                    "comment": "Использование тест-набора в средневековье может быть анахронизмом, но допустимо в рамках игрового допущения."
                },
                "Значимость": {
                    "rate": 9,
                    "comment": "Реплика важна для сюжета, так как подчёркивает важность осторожности и проверки воды, но могла бы более явно влиять на развитие персонажей."
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            }
        },
        {
            "id": 8,
            "info": "Сэм предлагает отдохнуть и насладиться оазисом.",
            "type": "C",
            "mood": "благодарный",
            "goal_achieved": {
                "item": -1,
                "info": -1
            },
            "to": [],
            "line": "Конечно, Майкл, давай отдохнём. Посмотри, как шелестят пальмы, будто шепчут нам: \"Остановитесь, насладитесь моментом\". Вода здесь прохладная и чистая — окуни ноги, почувствуй, как усталость уходит. А этот ветерок... он словно обнимает нас после долгого пути. Пусть песок станет нашей подушкой, а тень деревьев — укрытием. В такие минуты понимаешь, как прекрасно просто быть здесь и сейчас. Давай закроем глаза, вдохнём аромат цветов и поблагодарим этот оазис за его щедрость.",
            "need_regeneration": 0,
            "validation_result": {
                "Соответствие персонажу": {
                    "rate": 10,
                    "comment": ""
                },
                "Актуальность темы": {
                    "rate": 10,
                    "comment": ""
                },
                "Связность истории": {
                    "rate": 10,
                    "comment": ""
                },
                "Ясность": {
                    "rate": 10,
                    "comment": ""
                },
                "Точность в рамках мира и лора": {
                    "rate": 10,
                    "comment": ""
                },
                "Значимость": {
                    "rate": 9,
                    "comment": "Реплика вносит вклад в развитие атмосферы и отношений между персонажами, но не продвигает сюжет напрямую."
                },
                "Уникальность": {
                    "rate": 10,
                    "comment": ""
                }
            }
        }
    ]
}"""
    return a
