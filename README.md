# üß† Screenwriter Backend

–ü—Ä–æ–µ–∫—Ç backend-—Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ –º–µ–∂–¥—É –≥–ª–∞–≤–Ω—ã–º –≥–µ—Ä–æ–µ–º –∏ NPC —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM (Large Language Model). –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—Å—Ç–æ–≤ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏–≥—Ä.

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üì• –ü—Ä–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ –º–∏—Ä–µ, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ –∏ NPC —á–µ—Ä–µ–∑ API.
- ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏–∞–ª–æ–≥–∞ –∏ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å –ø–æ–º–æ—â—å—é DeepSeek Reasoner (LLM).
- üß© –†–∞–±–æ—Ç–∞ —Å LLM —á–µ—Ä–µ–∑ API DeepSeek (–∏—Å–ø–æ–ª—å–∑—É—è JSON-–ø—Ä–æ–º–ø—Ç—ã).
- üõ°Ô∏è JWT-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥, refresh —Ç–æ–∫–µ–Ω–∞, –∑–∞—â–∏—Ç–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤.
- üíæ –†–∞–±–æ—Ç–∞ —Å PostgreSQL —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π.
- üóëÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∫–∞ soft-delete –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (is_deleted) –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- üåê CORS-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º.
- üìÅ –ß–µ—Ç–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞.

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
screenwriter-backend/
‚îú‚îÄ‚îÄ .env                      # –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ certs/                    # –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á–∏ –¥–ª—è JWT (private.pem, public.pem)
‚îú‚îÄ‚îÄ pyproject.toml            # –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (poetry)
‚îú‚îÄ‚îÄ README.md                 # —ç—Ç–æ—Ç —Ñ–∞–π–ª
‚îÇ
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ database.py           # –º–æ–¥—É–ª—å —Ä–∞–±–æ—Ç—ã —Å PostgreSQL –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ users_db.py           # —Ä–∞–±–æ—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (is_deleted, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)
‚îÇ   ‚îî‚îÄ‚îÄ db_CRUD/              # CRUD –¥–ª—è –∏–≥—Ä, —Å—Ü–µ–Ω, –¥–∏–∞–ª–æ–≥–æ–≤, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
‚îÇ
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py           # –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils.py          # JWT, bcrypt, —Ä–∞–±–æ—Ç–∞ —Å –∫–ª—é—á–∞–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validator.py      # –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ llm/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generator.py      # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ —Ä–∞–±–æ—Ç–∞ —Å LLM
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py       # –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–µ–π
‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ schemas.py        # —Å—Ö–µ–º—ã Pydantic
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ app.py                # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FastAPI, CORS, –º–∞—Ä—à—Ä—É—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ main.py               # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ auth_endpoint.py # —Ä—É—á–∫–∏ /register, /login, /refresh, /protected
‚îÇ   ‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/db_endpoint.py   # —Ä—É—á–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –¥–∞–Ω–Ω—ã–º–∏
‚îÇ   ‚îî‚îÄ‚îÄ llm/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ api/
‚îÇ           ‚îú‚îÄ‚îÄ __init__.py
‚îÇ           ‚îî‚îÄ‚îÄ dialogue_endpoint.py # —Ä—É—á–∫–∞ /generate
‚îÇ
‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îú‚îÄ‚îÄ prompt_edges_content.txt
‚îÇ   ‚îú‚îÄ‚îÄ prompt_nodes_content.txt
‚îÇ   ‚îî‚îÄ‚îÄ prompt_structure.txt
‚îÇ
‚îî‚îÄ‚îÄ logs/
    ‚îî‚îÄ‚îÄ db.log                # –ª–æ–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
```

---

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –ö–ª–æ–Ω–∏—Ä—É–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

```bash
git clone https://github.com/hilyyx/screenwriter-backend.git
cd screenwriter-backend
```

2. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ Poetry:

```bash
poetry install
```

3. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —É–∫–∞–∂–∏ —Å–≤–æ–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```env
# DeepSeek API
DEEPSEEK_API_KEY=your-key-here
MODEL_TYPE_STRUCTURE_GENERATION=deepseek-reasoner
MODEL_TYPE_DIALOGUE_GENERATION=deepseek-chat
MODEL_TYPE_STRUCTURE_VALIDATION=deepseek-reasoner
MODEL_TYPE_DIALOGUE_VALIDATION=deepseek-chat
MODEL_TYPE_STRUCTURE_REGENERATION=deepseek-reasoner
MODEL_TYPE_DIALOGUE_REGENERATION=deepseek-chat
MODEL_MAX_TOKENS_STRUCTURE_GENERATION=20000
MODEL_MAX_TOKENS_DIALOGUE_GENERATION=8192
MODEL_MAX_TOKENS_STRUCTURE_VALIDATION=20000
MODEL_MAX_TOKENS_DIALOGUE_VALIDATION=8192
MODEL_MAX_TOKENS_STRUCTURE_REGENERATION=20000
MODEL_MAX_TOKENS_DIALOGUE_REGENERATION=8192

# Database
DB_NAME=your_db
DB_USER=your_user
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=5432

# JWT
ALGORITHM=RS256
# –ö–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ certs/private.pem –∏ certs/public.pem

# –ü—Ä–æ—á–µ–µ
APP_ENV=development
LOG_LEVEL=INFO
```

4. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∏ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á–∏ –¥–ª—è JWT:

```bash
openssl genrsa -out certs/private.pem 2048
openssl rsa -in certs/private.pem -pubout -out certs/public.pem
```

5. –ó–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```bash
poetry run uvicorn src.app:app --reload
```

---

## üì° –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

| –ú–µ—Ç–æ–¥ | URL                             | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
|-------|---------------------------------|------------------------------------------|
| POST  | `/api/generate`                 | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞                        |
| POST  | `/api/login`                    | –í—Ö–æ–¥, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT –∏ user.id           |
| POST  | `/api/register`                 | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞   |
| POST  | `/api/refresh`                  | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access_token                  |
| GET   | `/api/protected`                | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞                          |
| GET   | `/api/users/{user_id}`          | –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª—ë–Ω)   |
| GET   | `/api/get/users/{user_id}/data` | –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è             |
| POST  | `/api/users/{user_id}/data`     | –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è             |
| PUT   | `/api/users/{user_id}/name`     | –û–±–Ω–æ–≤–∏—Ç—å –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é                   |
| PUT   | `/api/users/{user_id}/password` | –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å                      |
| DELETE| `/api/users/{user_id}`          | –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (soft-delete)       |

---

## üõ°Ô∏è JWT –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

- –î–ª—è –≤—Å–µ—Ö –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç—Å—è JWT access_token.
- –ö–ª—é—á–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ certs/private.pem –∏ certs/public.pem.
- –¢–æ–∫–µ–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –∞–ª–≥–æ—Ä–∏—Ç–º–∞ RS256.
- –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç user.id –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
- –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª —É–¥–∞–ª—ë–Ω (is_deleted=True), –∞–∫–∫–∞—É–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

---

## üåê CORS

–í —Ñ–∞–π–ª–µ `src/app.py` —Ä–∞–∑—Ä–µ—à—ë–Ω –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å –Ω—É–∂–Ω–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://10.82.249.105:5173"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## üíæ –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

- –í—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ logs/db.log —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è soft-delete –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –ø–æ–ª–µ is_deleted.
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è RealDictCursor –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

---

## üß† DeepSeek Reasoner

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏—è –∏ –¥–∏–∞–ª–æ–≥–æ–≤.
- –†–∞–±–æ—Ç–∞–µ—Ç —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ (–¥–æ 20 000 —Ç–æ–∫–µ–Ω–æ–≤).
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ —Ü–µ–ø–æ—á–∫–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π.
- –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–µ–π –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ .env.

---
–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –ø—Ä–æ—è–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–∞—à–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ